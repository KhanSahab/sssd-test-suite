- name: Remove hostname from /etc/hosts
  become: True
  lineinfile:
    path: /etc/hosts
    regexp: '^(127\.0\.0\.1|::1)[ \t]+{{ ipa.hostname }}.*$'
    state: absent

- name: Install IPA server
  become: True
  shell: |
    /usr/sbin/ipa-server-install --unattended          \
      --realm={{ ipa.domain | upper | quote }}         \
      --domain={{ ipa.domain | quote }}                \
      --ds-password={{ ipa.password | quote }}         \
      --admin-password={{ ipa.password | quote }}      \
      --hostname={{ ipa.fqn | quote }}                 \
      --setup-dns                                      \
      --auto-forwarders                                \
      --auto-reverse                                   \
      --no-dnssec-validation                           \
      --no-host-dns
      
    /usr/sbin/ipa-adtrust-install --unattended         \
      --netbios-name={{ ipa.netbios | quote }}         \
      --admin-password={{ ipa.password | quote }}
  register: installed 
  args:
    creates: /etc/ipa/default.conf

- name: Remove IPA CA trust from previous installation
  become: True
  local_action:
    shell \
      FILE="{{ playbook_dir }}/../shared-enrollment/ipa/ca.crt"; \
      [ -f "$FILE" ] && /usr/bin/trust anchor --remove "$FILE" || exit 255
  register: result
  when: installed.changed
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"

- name: Copy certificate to shared folder
  become: True
  copy:
    force: True
    src: /etc/ipa/ca.crt
    dest: '/shared/enrollment/{{ inventory_hostname }}/'
    remote_src: yes
  register: cert_copy

- name: Trust IPA CA
  become: True
  local_action:
    shell /usr/bin/trust anchor "{{ playbook_dir }}/../shared-enrollment/ipa/ca.crt"
  when: cert_copy.changed

- name: Add DNS zones
  shell: |
    echo {{ ipa.password | quote }} | kinit admin
     
    ipa dnszone-show {{ item | quote }}
    if [ $? -eq 0 ]; then
      echo "Zone {{ item | quote }} already exists. Nothing to do."
      exit 255
    fi
     
    ipa dnszone-add {{ item | quote }}
  register: result
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"
  with_items:
  - '{{ ldap.domain }}'
  - '{{ client.domain }}'
  - '{{ network.reverse_zone }}'
  
- name: Add DNS zone forwarders for AD machines
  shell: |
    echo {{ ipa.password | quote }} | kinit admin
     
    ipa dnsforwardzone-show {{ item.zone | quote }}
    if [ $? -eq 0 ]; then
      echo "Zone forwarder for {{ item.zone | quote }} already exists. Nothing to do."
      exit 255
    fi
    
    ipa dnsforwardzone-add {{ item.zone | quote }}. --forwarder={{ item.forwarder | quote }} --forward-policy=only
  register: result
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"
  with_items:
  - { zone: '{{ ad.domain }}', forwarder: '{{ ad.ip }}'}
  - { zone: '{{ ad_child.domain }}', forwarder: '{{ ad_child.ip }}'}

- name: Add DNS A records
  shell: |
    echo {{ ipa.password | quote }} | kinit admin
     
    ipa dnsrecord-show {{ item.zone | quote }} {{ item.name | quote }}
    if [ $? -eq 0 ]; then
      echo "Record {{ item.name | quote }}.{{ item.zone | quote }} already exists. Nothing to do."
      exit 255
    fi
     
    ipa dnsrecord-add {{ item.zone | quote }} {{ item.name | quote }} \
      --a-ip-address {{ item.ip | quote }}
  register: result
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"
  with_items:
  - { zone: '{{ ldap.domain }}', name: '{{ ldap.hostname }}', ip: '{{ ldap.ip }}'}
  - { zone: '{{ client.domain }}', name: '{{ client.hostname }}', ip: '{{ client.ip }}'}

- name: Add DNS SRV records
  shell: |
    echo {{ ipa.password | quote }} | kinit admin
     
    ipa dnsrecord-show {{ item.zone | quote }} {{ item.name | quote }}
    if [ $? -eq 0 ]; then
      echo "Record {{ item.name | quote }}.{{ item.zone | quote }} already exists. Nothing to do."
      exit 255
    fi
     
    ipa dnsrecord-add {{ item.zone | quote }} {{ item.name }}     \
      --srv-target={{ item.target | quote }}.                     \
      --srv-priority=0 --srv-weight=100 --srv-port=389
  register: result
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"
  with_items:
  - { zone: '{{ ldap.domain }}', name: '_ldap._tcp', target: '{{ ldap.fqn }}'}

- name: Add DNS PTR records
  shell: |
    PTR_NAME={{ item.ip | regex_replace('.+\.(\d+)', '\1') | quote }}
    echo {{ ipa.password | quote }} | kinit admin
     
    ipa dnsrecord-show {{ item.zone | quote }} $PTR_NAME
    if [ $? -eq 0 ]; then
      echo "Record $PTR_NAME.{{ item.zone | quote }} already exists. Nothing to do."
      exit 255
    fi
     
    ipa dnsrecord-add {{ item.zone | quote }} $PTR_NAME \
      --ptr-hostname={{ item.target | quote }}
  register: result
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"
  with_items:
  - { zone: '{{ network.reverse_zone }}', ip: '{{ ldap.ip }}',     target: '{{ ldap.fqn }}.'}
  - { zone: '{{ network.reverse_zone }}', ip: '{{ client.ip }}',   target: '{{ client.fqn }}.'}
  - { zone: '{{ network.reverse_zone }}', ip: '{{ ad.ip }}',       target: '{{ ad.fqn }}.'}
  - { zone: '{{ network.reverse_zone }}', ip: '{{ ad_child.ip }}', target: '{{ ad_child.fqn }}.'}
  
- name: 'Setup trust with {{ ad.domain }}'
  shell: |
    echo {{ ipa.password | quote }} | kinit admin
     
    ipa trust-show {{ ad.domain | quote }}
    if [ $? -eq 0 ]; then
      echo "Trust with {{ ad.domain | quote }} already exists. Nothing to do."
      exit 255
    fi
     
    echo vagrant | ipa trust-add {{ ad.domain | quote }} --admin Administrator --password
  register: result
  failed_when: "result.rc != 255 and result.rc != 0"
  changed_when: "result.rc == 0"
